root@cloud:~/PhucAnDuongCMS-3# #!/bin/bash
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     FULL SYSTEM DIAGNOSTIC TEST           â•‘"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo ""

# 1. Check App Status
echo "1ï¸âƒ£  APP STATUS"
pm2 list | grep -E "phuan-app|name.*pid.*status"
APP_STATUS=$(pm2 list | grep phuan-app | grep -o "online\|stopped\|errored")
if [ "$APP_STATUS" = "online" ]; then
  echo "âœ… App is running"
else
  echo "âŒ App is NOT running: $APP_STATUS"
fi
echo ""

# 2. Check PostgreSQL
echo "2ï¸âƒ£  DATABASE STATUS"
PG_RUNNING=$(ps aux | grep postgres | grep -v grep | wc -l)
if [ $PG_RUNNING -gt 0 ]; then
  echo "âœ… PostgreSQL is running ($PG_RUNNING processes)"
  PGPASSWORD='PhucAn2025!' psql -h localhost -U postgres -d phuanduong_db -c "SELECT version();" 2>&1 | grep -q "PostgreSQL" && echo "âœ… Database connection OK" || echo "âŒ Database connection FAILED"
else
  echo "âŒ PostgreSQL is NOT running"
fi
echo ""

# 3. Check Database Tables
echo "3ï¸âƒ£  DATABASE TABLES"
PGPASSWORD='PhucAn2025!' psql -h localhost -U postgres -d phuanduong_db -c "
  SELECT 
    'users' as table_name, COUNT(*) as records FROM users
  UNION ALL SELECT 'branches', COUNT(*) FROM branches
  UNION ALL SELECT 'cards', COUNT(*) FROM cards
  UNION ALL SELECT 'staff', COUNT(*) FROM staff
  UNION ALL SELECT 'session', COUNT(*) FROM session;
" 2>&1 | grep -E "table_name|users|branches|cards|staff|session"
echo ""

# 4. Test Authentication
echo "4ï¸âƒ£  AUTHENTICATION TEST"
LOGIN_RESPONSE=$(curl -s -X POST http://103.72.96.173:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@phuan.com","password":"admin123"}' \
  -c /tmp/health_check.txt -w "\n%{http_code}")
LOGIN_CODE=$(echo "$LOGIN_RESPONSE" | tail -1)
if [ "$LOGIN_CODE" = "200" ]; then
  echo "âœ… Login works (HTTP $LOGIN_CODE)"
else
  echo "âŒ Login failed (HTTP $LOGIN_CODE)"
fi
echo ""

# 5. Test Core APIs
echo "5ï¸âƒ£  API ENDPOINTS TEST"
declare -a endpoints=("/api/user" "/api/dashboard/metrics" "/api/cards" "/api/branches" "/api/staff")
for endpoint in "${endpoints[@]}"; do
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://103.72.96.173:5000$endpoint -b /tmp/health_check.txt)
  if [ "$HTTP_CODE" = "200" ]; then
    echo "âœ… $endpoint â†’ HTTP $HTTP_CODE"
  else
    echo "âŒ $endpoint â†’ HTTP $HTTP_CODE"
echo "Admin: admin@phuan.com / admin123"N"IN_CODE" = "200" ] && [ $ERROR_COUNT -lt 10 ]; thenxception\|fatal" | wc -l)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     FULL SYSTEM DIAGNOSTIC TEST           â•‘
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

1ï¸âƒ£  APP STATUS
â”‚ id â”‚ name         â”‚ namespace   â”‚ version â”‚ mode    â”‚ pid      â”‚ uptime â”‚ â†º    â”‚ status    â”‚ cpu      â”‚ mem      â”‚ user     â”‚ watching â”‚
â”‚ 0  â”‚ phuan-app    â”‚ default     â”‚ 1.0.0   â”‚ fork    â”‚ 2734108  â”‚ 7m     â”‚ 244  â”‚ online    â”‚ 0%       â”‚ 123.4mb  â”‚ root     â”‚ disabled â”‚
âœ… App is running

2ï¸âƒ£  DATABASE STATUS
âœ… PostgreSQL is running (7 processes)
âœ… Database connection OK

3ï¸âƒ£  DATABASE TABLES
 table_name | records 
 users      |       2
 branches   |       2
 cards      |       3
 staff      |       3
 session    |       8

4ï¸âƒ£  AUTHENTICATION TEST
âœ… Login works (HTTP 200)

5ï¸âƒ£  API ENDPOINTS TEST
âœ… /api/user â†’ HTTP 200
âœ… /api/dashboard/metrics â†’ HTTP 200
âœ… /api/cards â†’ HTTP 200
âœ… /api/branches â†’ HTTP 200
âœ… /api/staff â†’ HTTP 200

6ï¸âƒ£  ERROR LOGS (last 10 lines)
Total errors in last 100 lines: 6
âš ï¸  Warning: High error count detected
0|phuan-ap |     release: [Function (anonymous)],
0|phuan-ap |     activeQuery: null,
0|phuan-ap |     readyForQuery: true,
0|phuan-ap |     hasExecuted: true,
0|phuan-ap |     _poolUseCount: 4,
0|phuan-ap |     [Symbol(shapeMode)]: false,
0|phuan-ap |     [Symbol(kCapture)]: false
0|phuan-ap |   }
0|phuan-ap | }


7ï¸âƒ£  PERFORMANCE METRICS
CPU: fork | Memory: â”‚ | Restarts: 1.0.0

8ï¸âƒ£  DISK SPACE
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        20G  9.1G   11G  46% /

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            TEST SUMMARY                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‰ System Status: HEALTHY

URL: http://103.72.96.173:5000
Admin: admin@phuan.com / admin123
root@cloud:~/PhucAnDuongCMS-3# 
